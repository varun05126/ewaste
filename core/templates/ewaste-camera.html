<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Waste AI Detection</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            text-align: center;
            padding: 20px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        #video-box {
            background: white;
            width: 420px;
            margin: auto;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0px 3px 10px rgba(0,0,0,0.15);
        }

        video {
            width: 100%;
            border-radius: 10px;
        }

        /* ITEM SELECT DROPDOWN */
        #item-select {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        #item-select:focus {
            outline: none;
            border-color: #222;
        }

        .detect-btn {
            margin-top: 10px;
            background: #222;
            padding: 12px 22px;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border: none;
            width: 100%;
        }

        .detect-btn:hover {
            background: #444;
        }

        /* RESULT BOX */
        .ewaste-box {
            background: #28a745;
            color: #fff;
            padding: 18px;
            border-radius: 10px;
            width: 280px;
            margin: 20px auto;
            font-size: 22px;
            font-weight: bold;
        }

        .not-ewaste-box {
            background: #dc3545;
            color: #fff;
            padding: 18px;
            border-radius: 10px;
            width: 280px;
            margin: 20px auto;
            font-size: 22px;
            font-weight: bold;
        }

        #autoToggle {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #auto-label {
            font-size: 18px;
            margin-left: 8px;
            font-weight: bold;
        }

        #object-name {
            font-size: 18px;
            color: #555;
            margin-top: 15px;
        }
    </style>
</head>

<body>

    <h1>E-Waste AI Detection</h1>
    <p id="subtext">Auto-detecting every 1 second...</p>

    <!-- AUTO-DETECT TOGGLE -->
    <div style="margin-bottom: 20px;">
        <input type="checkbox" id="autoToggle" checked>
        <label id="auto-label">Auto Detect</label>
    </div>

    <!-- CAMERA AREA -->
    <div id="video-box">
        <video id="camera" autoplay></video>

        <!-- ITEM SELECT DROPDOWN -->
        <select id="item-select">
            <option value="">-- Select Item Type --</option>
            <option value="phone">ğŸ“± Phone/Mobile</option>
            <option value="charger">ğŸ”Œ Charger</option>
            <option value="laptop">ğŸ’» Laptop</option>
            <option value="tablet">ğŸ“² Tablet</option>
            <option value="headphones">ğŸ§ Headphones</option>
            <option value="keyboard">âŒ¨ï¸ Keyboard</option>
            <option value="mouse">ğŸ–±ï¸ Mouse</option>
            <option value="monitor">ğŸ–¥ï¸ Monitor</option>
            <option value="cable">ğŸ”— Cable</option>
            <option value="battery">ğŸ”‹ Battery</option>
            <option value="powerbank">âš¡ PowerBank</option>
            <option value="speaker">ğŸ”Š Speaker</option>
            <option value="camera">ğŸ“· Camera</option>
            <option value="earbuds">ğŸµ Earbuds</option>
            <option value="adapter">ğŸ”Œ Adapter</option>
            <option value="remote">ğŸ“¡ Remote</option>
            <option value="webcam">ğŸ“¹ Webcam</option>
        </select>

        <button class="detect-btn" id="detectButton">Manual Detect</button>
    </div>

    <!-- RESULT -->
    <div id="result-box" class="not-ewaste-box">Waiting...</div>
    <div id="object-name">Object: â€”</div>

    <!-- Hidden canvas -->
    anvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
////////////////////////////////////////////////////////////////////////////////
//  AUDIO UNLOCK â€” REQUIRED FOR SAFARI & CHROME
////////////////////////////////////////////////////////////////////////////////
document.body.addEventListener("click", function enableAudio() {
    let a1 = document.getElementById("sound-detect");
    let a2 = document.getElementById("sound-ewaste");
    let a3 = document.getElementById("sound-not-ewaste");

    a1.play().catch(()=>{});
    a2.play().catch(()=>{});
    a3.play().catch(()=>{});

    document.body.removeEventListener("click", enableAudio);
});

////////////////////////////////////////////////////////////////////////////////
//  CAMERA STREAM
////////////////////////////////////////////////////////////////////////////////

const video = document.getElementById("camera");
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => video.srcObject = stream);

// AUTO DETECT CONTROL
let autoMode = true;
let autoInterval = null;

document.getElementById("autoToggle").addEventListener("change", function () {
    autoMode = this.checked;

    if (autoMode) {
        document.getElementById("subtext").innerText = "Auto-detecting every 1 second...";
        startAutoDetect();
    } else {
        document.getElementById("subtext").innerText = "Manual mode enabled";
        stopAutoDetect();
    }
});

// Start auto mode by default
startAutoDetect();

function startAutoDetect() {
    stopAutoDetect();
    autoInterval = setInterval(() => {
        captureAndSend();
    }, 1000);
}

function stopAutoDetect() {
    if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
    }
}

// Manual Detect
document.getElementById("detectButton").addEventListener("click", () => {
    captureAndSend();
});

////////////////////////////////////////////////////////////////////////////////
// CAPTURE FRAME + SEND WITH SELECTED ITEM
////////////////////////////////////////////////////////////////////////////////

function captureAndSend() {
    const canvas = document.getElementById("hiddenCanvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    const imageData = canvas.toDataURL("image/jpeg");
    const selectedItem = document.getElementById("item-select").value;

    // Build form data
    let bodyData = "image=" + encodeURIComponent(imageData);
    if (selectedItem) {
        bodyData += "&item=" + encodeURIComponent(selectedItem);
    }

    fetch("/api/camera-detect/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: bodyData
    })
    .then(res => res.json())
    .then(data => updateUI(data.detected, data.caption))
    .catch(err => {
        console.error("Error:", err);
        updateUI("error", "connection_error");
    });
}

////////////////////////////////////////////////////////////////////////////////
// UI UPDATE + SOUND
////////////////////////////////////////////////////////////////////////////////

function updateUI(result, caption) {
    const box = document.getElementById("result-box");
    const name = document.getElementById("object-name");

    if (!caption) caption = "unknown";

    // Always play "object detected" sound
    try {
        document.getElementById("sound-detect").play().catch(()=>{});
    } catch (e) {}

    if (result === "ewaste") {
        box.className = "ewaste-box";
        box.innerHTML = "â™»ï¸ EWASTE âœ”";

        try {
            document.getElementById("sound-ewaste").play().catch(()=>{});
        } catch (e) {}
    } else if (result === "error") {
        box.className = "not-ewaste-box";
        box.innerHTML = "âš ï¸ ERROR";
        name.innerText = "Object: " + caption;
    } else {
        box.className = "not-ewaste-box";
        box.innerHTML = "âŒ NOT EWASTE";

        try {
            document.getElementById("sound-not-ewaste").play().catch(()=>{});
        } catch (e) {}
    }

    name.innerText = "Object: " + caption;
}
</script>

<!-- AUDIO FILES -->
<audio id="sound-detect" src="/static/sounds/object_detected.mp3"></audio>
<audio id="sound-ewaste" src="/static/sounds/ewaste.mp3"></audio>
<audio id="sound-not-ewaste" src="/static/sounds/not_ewaste.mp3"></audio>

</body>
</html>
